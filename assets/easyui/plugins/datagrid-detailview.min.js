$.extend($.fn.datagrid.defaults,{autoUpdateDetail:!0});var detailview=$.extend({},$.fn.datagrid.defaults.view,{render:function(t,a,d){var e=$.data(t,"datagrid"),i=e.options;if(!d||i.rownumbers||i.frozenColumns&&i.frozenColumns.length){var r=e.data.rows,n=$(t).datagrid("getColumnFields",d),o=[];o.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var s=0;s<r.length;s++){var l=i.rowStyler?i.rowStyler.call(t,s,r[s]):"",g="",c="";"string"==typeof l?c=l:l&&(g=l.class||"",c=l.style||"");var h='class="datagrid-row '+(s%2&&i.striped?"datagrid-row-alt ":" ")+g+'"',u=c?'style="'+c+'"':"",p=e.rowIdPrefix+"-"+(d?1:2)+"-"+s;o.push('<tr id="'+p+'" datagrid-row-index="'+s+'" '+h+" "+u+">"),o.push(this.renderRow.call(this,t,n,d,s,r[s])),o.push("</tr>"),o.push('<tr style="display:none;">'),d?o.push("<td colspan="+(n.length+(i.rownumbers?1:0))+' style="border-right:0">'):o.push("<td colspan="+n.length+">"),o.push('<div class="datagrid-row-detail">'),d?o.push("&nbsp;"):o.push(i.detailFormatter.call(t,s,r[s])),o.push("</div>"),o.push("</td>"),o.push("</tr>")}o.push("</tbody></table>"),$(a).html(o.join(""))}},renderRow:function(t,a,d,e,i){var r=$.data(t,"datagrid").options,n=[];if(d&&r.rownumbers){var o=e+1;r.pagination&&(o+=(r.pageNumber-1)*r.pageSize),n.push('<td class="datagrid-td-rownumber"><div class="datagrid-cell-rownumber">'+o+"</div></td>")}for(var s=0;s<a.length;s++){var l=a[s],g=$(t).datagrid("getColumnOption",l);if(g){var c=i[l],h=g.styler&&g.styler(c,i,e)||"",u="",p="";"string"==typeof h?p=h:n&&(u=h.class||"",p=h.style||"");var f=u?'class="'+u+'"':"",v=g.hidden?'style="display:none;'+p+'"':p?'style="'+p+'"':"";n.push('<td field="'+l+'" '+f+" "+v+">"),g.checkbox?v="":g.expander?v="text-align:center;height:16px;":(v=p,g.align&&(v+=";text-align:"+g.align+";"),r.nowrap?r.autoRowHeight&&(v+=";height:auto;"):v+=";white-space:normal;height:auto;"),n.push('<div style="'+v+'" '),g.checkbox?n.push('class="datagrid-cell-check '):n.push('class="datagrid-cell '+g.cellClass),n.push('">'),g.checkbox?n.push('<input type="checkbox" name="'+l+'" value="'+(null!=c?c:"")+'">'):g.expander?n.push('<span class="datagrid-row-expander datagrid-row-expand" style="display:inline-block;width:16px;height:16px;cursor:pointer;" />'):g.formatter?n.push(g.formatter(c,i,e)):n.push(c),n.push("</div>"),n.push("</td>")}}return n.join("")},insertRow:function(i,r,n){var o=$.data(i,"datagrid").options,t=$.data(i,"datagrid").dc,s=($(i).datagrid("getPanel"),t.view1,t.view2,!1),a=$(i).datagrid("getRows").length;function d(t){var a=o.finder.getTr(i,r,"body",t?1:2);if(s){var d=a.next(),e=a.next().clone();a.insertAfter(d)}else e=a.next().next().clone();e.insertAfter(a),e.hide(),t||e.find("div.datagrid-row-detail").html(o.detailFormatter.call(i,r,n))}0!=a?((null==r||null==r||a<=r)&&(r=a,s=!0,this.canUpdateDetail=!1),$.fn.datagrid.defaults.view.insertRow.call(this,i,r,n),d(!0),d(!1),this.canUpdateDetail=!0):$(i).datagrid("loadData",{total:1,rows:[n]})},deleteRow:function(t,a){var d=$.data(t,"datagrid").options,e=$.data(t,"datagrid").dc;d.finder.getTr(t,a).next().remove(),$.fn.datagrid.defaults.view.deleteRow.call(this,t,a),e.body2.triggerHandler("scroll")},updateRow:function(t,a,d){$.data(t,"datagrid").dc;var e=$.data(t,"datagrid").options,i=$(t).datagrid("getExpander",a).attr("class");if($.fn.datagrid.defaults.view.updateRow.call(this,t,a,d),$(t).datagrid("getExpander",a).attr("class",i),e.autoUpdateDetail&&this.canUpdateDetail){d=$(t).datagrid("getRows")[a];$(t).datagrid("getRowDetail",a).html(e.detailFormatter.call(t,a,d))}},bindEvents:function(i){var t=$.data(i,"datagrid");if(!t.ss.bindDetailEvents){t.ss.bindDetailEvents=!0;var a=t.dc,d=(t.options,a.body1.add(a.body2)),r=($.data(d[0],"events")||$._data(d[0],"events")).click[0].handler;d.unbind("click").bind("click",function(t){var a=$(t.target),d=a.closest("tr.datagrid-row");if(d.length){if(a.hasClass("datagrid-row-expander")){var e=parseInt(d.attr("datagrid-row-index"));a.hasClass("datagrid-row-expand")?$(i).datagrid("expandRow",e):$(i).datagrid("collapseRow",e),$(i).datagrid("fixRowHeight")}else r(t);t.stopPropagation()}})}},onBeforeRender:function(t){for(var a=$.data(t,"datagrid"),d=a.options,e=a.dc,i=!1,r=(o=$(t)).datagrid("getColumnFields",!0).concat(o.datagrid("getColumnFields")),n=0;n<r.length;n++){if(o.datagrid("getColumnOption",r[n]).expander){i=!0;break}}if(!i){d.frozenColumns&&d.frozenColumns.length?d.frozenColumns[0].splice(0,0,{field:"_expander",expander:!0,width:24,resizable:!1,fixed:!0}):d.frozenColumns=[[{field:"_expander",expander:!0,width:24,resizable:!1,fixed:!0}]];var o=e.view1.children("div.datagrid-header").find("table"),s=$('<td rowspan="'+d.frozenColumns.length+'"><div class="datagrid-header-expander" style="width:24px;"></div></td>');0==$("tr",o).length?s.wrap("<tr></tr>").parent().appendTo($("tbody",o)):d.rownumbers?s.insertAfter(o.find("td:has(div.datagrid-header-rownumber)")):s.prependTo(o.find("tr:first"))}},onAfterRender:function(i){var r=$.data(i,"datagrid"),d=r.dc,n=r.options,e=$(i).datagrid("getPanel");function o(){var t=d.body2.find(">table.datagrid-btable>tbody>tr>td>div.datagrid-row-detail:visible");if(t.length){var a=0;d.header2.find(".datagrid-header-check:visible,.datagrid-cell:visible").each(function(){a+=$(this).outerWidth(!0)+1}),a!=t.outerWidth(!0)&&(t._outerWidth(a),t.find(".easyui-fluid").trigger("_resize"))}}$.fn.datagrid.defaults.view.onAfterRender.call(this,i),r.onResizeColumn||(r.onResizeColumn=n.onResizeColumn,n.onResizeColumn=function(t,a){n.fitColumns||o();for(var d=$(i).datagrid("getRows").length,e=0;e<d;e++)$(i).datagrid("fixDetailRowHeight",e);r.onResizeColumn.call(i,t,a)}),r.onResize||(r.onResize=n.onResize,n.onResize=function(t,a){n.fitColumns&&o(),r.onResize.call(e,t,a)}),this.canUpdateDetail=!0,d.footer1.add(d.footer2).find("span.datagrid-row-expander").css("visibility","hidden"),$(i).datagrid("resize"),this.bindEvents(i),d.body1.add(d.body2).find("div.datagrid-row-detail").unbind().bind("mouseover mouseout click dblclick contextmenu scroll",function(t){t.stopPropagation()})}});$.extend($.fn.datagrid.methods,{fixDetailRowHeight:function(t,r){return t.each(function(){var t=$.data(this,"datagrid").options;if(t.rownumbers||t.frozenColumns&&t.frozenColumns.length){var a=$.data(this,"datagrid").dc,d=t.finder.getTr(this,r,"body",1).next(),e=t.finder.getTr(this,r,"body",2).next();if(e.is(":visible")){d.css("height",""),e.css("height","");var i=Math.max(d.height(),e.height());d.css("height",i),e.css("height",i)}a.body2.triggerHandler("scroll")}})},getExpander:function(t,a){return $.data(t[0],"datagrid").options.finder.getTr(t[0],a).find("span.datagrid-row-expander")},getRowDetail:function(t,a){return $.data(t[0],"datagrid").options.finder.getTr(t[0],a,"body",2).next().find(">td>div.datagrid-row-detail")},expandRow:function(t,r){return t.each(function(){var t=$(this).datagrid("options"),a=($.data(this,"datagrid").dc,$(this).datagrid("getExpander",r));if(a.hasClass("datagrid-row-expand")){a.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse");var d=t.finder.getTr(this,r,"body",1).next(),e=t.finder.getTr(this,r,"body",2).next();if(d.show(),e.show(),$(this).datagrid("fixDetailRowHeight",r),t.onExpandRow){var i=$(this).datagrid("getRows")[r];t.onExpandRow.call(this,r,i)}}})},collapseRow:function(t,n){return t.each(function(){var t=$(this).datagrid("options"),a=$.data(this,"datagrid").dc,d=$(this).datagrid("getExpander",n);if(d.hasClass("datagrid-row-collapse")){d.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand");var e=t.finder.getTr(this,n,"body",1).next(),i=t.finder.getTr(this,n,"body",2).next();if(e.hide(),i.hide(),a.body2.triggerHandler("scroll"),t.onCollapseRow){var r=$(this).datagrid("getRows")[n];t.onCollapseRow.call(this,n,r)}}})}}),$.extend($.fn.datagrid.methods,{subgrid:function(t,a){return t.each(function(){function o(t){var a=$(t).children("div");return a.children("div.datagrid").length?a.find(">div.datagrid>div.panel-body>div.datagrid-view>table.datagrid-subgrid"):a.find(">table.datagrid-subgrid")}function s(t){var a=$(t).closest("div.datagrid-row-detail").closest("tr").prev();if(a.length){var d=parseInt(a.attr("datagrid-row-index"));l(a.closest("div.datagrid-view").children("table")[0],d)}}function l(t,a){$(t).datagrid("fixDetailRowHeight",a),$(t).datagrid("fixRowHeight",a);var d=$(t).closest("div.datagrid-row-detail").closest("tr").prev();if(d.length){a=parseInt(d.attr("datagrid-row-index"));l(d.closest("div.datagrid-view").children("table")[0],a)}}!function r(t,n,a){var d=$.extend({},n.options.queryParams||{});if(a){var e=n.options.foreignField;$.isFunction(e)?$.extend(d,e.call(n,a)):d[e]=a[e]}var i=n.options.edatagrid?"edatagrid":"datagrid";$(t)[i]($.extend({},n.options,{subgrid:n.subgrid,view:n.subgrid?detailview:void 0,queryParams:d,detailFormatter:function(t,a){return'<div><table class="datagrid-subgrid"></table></div>'},onExpandRow:function(t,a){var d=$(this).datagrid("options"),e=$(this).datagrid("getRowDetail",t),i=o(e);i.data("datagrid")||r(i[0],d.subgrid,a),e.find(".easyui-fluid").trigger("_resize"),l(this,t),n.options.onExpandRow&&n.options.onExpandRow.call(this,t,a)},onCollapseRow:function(t,a){l(this,t),n.options.onCollapseRow&&n.options.onCollapseRow.call(this,t,a)},onResize:function(){$(this).children("div.datagrid-view").children("table");s(this)},onResizeColumn:function(t,a){s(this),n.options.onResizeColumn&&n.options.onResizeColumn.call(this,t,a)},onLoadSuccess:function(t){s(this),n.options.onLoadSuccess&&n.options.onLoadSuccess.call(this,t)}}))}(this,a)})},getSelfGrid:function(t){var a=t.closest(".datagrid");return a.length?a.find(">.datagrid-wrap>.datagrid-view>.datagrid-f"):null},getParentGrid:function(t){var a=t.closest("div.datagrid-row-detail");return a.length?a.closest(".datagrid-view").children(".datagrid-f"):null},getParentRowIndex:function(t){var a=t.closest("div.datagrid-row-detail");if(a.length){var d=a.closest("tr").prev();return parseInt(d.attr("datagrid-row-index"))}return-1}});